$( document ).ready(function() {
  $('.requests-datatable').each(function(index){
    // 1. Create DataTable
    var dataTableId = $(this).attr('id');
    var typeDropdown = $('select[name=request_type_select][data-table=' + dataTableId + ']');
    var stateDropdown = $('select[name=request_state_select][data-table=' + dataTableId + ']');
    var url = $(this).data('source');

    var table = $(this).dataTable({
      order: [[0,'desc']],
      info: false,
      columnDefs: [
        // We dont allow ordering by the request link.
        // Columns: created, source, target, requester, type, priority, request link.
        // First column has index 0.
        { orderable: false, targets: [6] }
      ],
      paging: 25,
      pageLength: 25,
      pagingType: "full_numbers",
      processing: true,
      language: {
         processing: '<img src="<%= asset_path "ajax-loader.gif" %>"> Processing...'
      },
      serverSide: true,
      ajax: {
        url: url,
        data: function(d) {
          d.dataTableId = dataTableId;
          d.type = typeDropdown.val();
          d.state = stateDropdown.val();
        }
      }
    });

    // 2. Reload button (if it exists)
    var reloadButton = $('.result_reload[data-table=' + dataTableId + ']');

    reloadButton.click(function(){
      var loadingSpinner = $(reloadButton).siblings('.result_spinner');
      reloadButton.hide();
      loadingSpinner.show();

      table.api().ajax.reload(function(){
        reloadButton.show();
        loadingSpinner.hide();
      });
    });

    // 3. Type dropdown (if it exists)
    var loadingSpinner = $('#spinner');

    typeDropdown.change(function(){
      loadingSpinner.show();

      table.api().ajax.reload(function(){
        loadingSpinner.hide();
      }, false);
    });

    // 4. State dropdown (if it exists)
    stateDropdown.change(function(){
      loadingSpinner.show();

      table.api().ajax.reload(function(){
        loadingSpinner.hide();
      }, false);
    });
  });
});

$(document).on('xhr.dt', '.requests-datatable', function(e, settings, json) {
  if (json) {
    $('#request_count').text('(' + json.recordsTotal + ')');
  }
});


